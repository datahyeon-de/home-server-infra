# 1. Namespace & ServiceAccount
apiVersion: v1
kind: Namespace
metadata:
  name: airflow
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: airflow-sa
  namespace: airflow
---
# 2. RBAC: 에어플로우가 자기 방과 Spark 방을 모두 관리할 권한
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: airflow-cluster-admin
rules:
  - apiGroups: ["", "apps", "batch", "sparkoperator.k8s.io"]
    resources: ["pods", "pods/log", "pods/exec", "services", "configmaps", "secrets", "sparkapplications", "sparkapplications/status"]
    verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: airflow-cluster-admin-binding
subjects:
  - kind: ServiceAccount
    name: airflow-sa
    namespace: airflow
roleRef:
  kind: ClusterRole
  name: airflow-cluster-admin
  apiGroup: rbac.authorization.k8s.io
---
# 3. Storage: DB 및 로그용 PV/PVC
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: manual
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: airflow-pg-pv
spec:
  capacity: { storage: 50Gi }
  accessModes: ["ReadWriteOnce"]
  storageClassName: manual
  hostPath: { path: "/mnt/airflow-data" }
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values: ["k8s-worker-01"]
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: airflow-pg-pvc
  namespace: airflow
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: manual
  resources: { requests: { storage: 50Gi } }