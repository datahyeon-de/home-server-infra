# playbooks/tests/resource-throttling/01_unit_setup_test_vm.yml
---
- name: "[Unit] Setup Test VM via API"
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - "../../group_vars/all.yml"
    - "./vars.yml"

  tasks:
    - name: "TEST | 1-1 | Check if Test VM already exists"
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ test_vm.target_node }}/qemu/{{ test_vm.vmid }}/status/current"
        method: GET
        headers: { Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}" }
        validate_certs: false
      register: check_res
      ignore_errors: true

    - name: "TEST | 1-2 | Fail if VM exists (for clean test)"
      fail:
        msg: "VM {{ test_vm.vmid }} already exists. Please clean up first."
      when: check_res.status == 200

    - name: "TEST | 1-3 | Clone VM from Template"
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ test_vm.target_node }}/qemu/{{ test_vm.template_id }}/clone"
        method: POST
        headers: { Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}" }
        body_format: form-urlencoded
        body: { newid: "{{ test_vm.vmid }}", name: "{{ test_vm.name }}", full: 0 }
        validate_certs: false
      register: clone_res

    - name: "TEST | 1-4 | Wait for Clone Task to Complete"
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ test_vm.target_node }}/tasks/{{ clone_res.json.data }}/status"
        method: GET
        headers: { Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}" }
        validate_certs: false
      register: poll
      until: "poll.json.data.status == 'stopped'"
      retries: 30
      delay: 5
