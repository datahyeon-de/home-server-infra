---
- name: 01-PROVISION-VMS | Start VM Provisioning Pipeline (Hybrid Mode)
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - "../../vars/vm_list.yml"
    - "../../group_vars/all.yml"
  vars:
    move_task_tracking: [] # 비동기 move_disk UPID 추적용 리스트

  tasks:
    - name: 01-1 | Process New VMs
      include_tasks: "tasks/01-process-single-vm.yml"
      loop: "{{ vm_configs | selectattr('existing', 'equalto', false) | list }}"
      loop_control:
        loop_var: vm

    - name: 01-2 | Final Wait: Verify All Move Disk Tasks
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ item.node }}/tasks/{{ item.upid }}/status"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}"
        validate_certs: false
      register: move_poll_res
      until: "move_poll_res.json.data.status == 'stopped'"
      retries: 150
      delay: 10
      loop: "{{ move_task_tracking }}"
      when: move_task_tracking | length > 0

    - name: 01-3 | Inventory Update: Mark all processed VMs as existing
      ansible.builtin.replace:
        path: "../../vars/vm_list.yml"
        regexp: '(?m)^(  - vmid: {{ item.vmid }}\n(    .*\n)* existing: )false$'
        replace: '\1true'
      loop: "{{ move_task_tracking }}"
      when: move_task_tracking | length > 0