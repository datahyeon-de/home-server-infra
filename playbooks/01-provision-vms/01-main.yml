---
- name: 01-PROVISION-VMS | Start VM Provisioning Pipeline (Hybrid & Sync Mode)
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - "../../vars/vm_list.yml"
    - "../../group_vars/all.yml"
  vars:
    move_task_tracking: [] 

  tasks:
    - name: 01-1 | Process New or Existing VMs
      include_tasks: "tasks/01-process-single-vm.yml"
      loop: "{{ vm_configs | selectattr('existing', 'equalto', false) | list }}"
      loop_control:
        loop_var: vm

    - name: 01-2 | Final Wait: Verify Move Disk Tasks (Exclude Manual Sync)
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ item.node }}/tasks/{{ item.upid }}/status"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}"
        validate_certs: false
      register: move_poll_res
      until: "move_poll_res.json.data.status == 'stopped'"
      retries: 150
      delay: 10
      loop: "{{ move_task_tracking }}"
      # [핵심] 수동 동기화 대상은 Polling을 건너뜁니다.
      when: 
        - move_task_tracking | length > 0
        - item.upid != 'manual_sync'

    - name: 01-3 | Inventory Update: Sync vm_list.yml to existing=true
      ansible.builtin.replace:
        path: "../../vars/vm_list.yml"
        regexp: '(?m)^(  - vmid: {{ item.vmid }}\n(    .*\n)* existing: )false$'
        replace: '\1true'
      loop: "{{ move_task_tracking }}"
      when: move_task_tracking | length > 0