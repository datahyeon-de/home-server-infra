- hosts: localhost
  connection: local
  vars_files: ["../../group_vars/all.yml", "vars.yml"]
  tasks:
    - name: "TEST(Ubuntu) | 3-1 | Inject Cloud-init (SSH + IP)"
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ test_vm.target_node }}/qemu/{{ test_vm.vmid }}/config"
        method: PUT
        headers: { Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}" }
        body_format: form-urlencoded
        body:
          # [핵심 수정] replace를 사용하여 모든 줄바꿈 문자를 명시적으로 제거합니다.
          sshkeys: "{{ lookup('file', bastion_ssh_key_path) | replace('\n', '') | replace('\r', '') | trim }}"
          ipconfig0: "ip={{ test_vm.ip }}{{ network_netmask }},gw={{ network_gateway }}"
        validate_certs: false
        validate_certs: false

    - name: "TEST | 3-2 | Start Move Disk"
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ test_vm.target_node }}/qemu/{{ test_vm.vmid }}/move_disk"
        method: POST
        headers: { Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}" }
        body_format: form-urlencoded
        body: { disk: "scsi0", storage: "{{ storage_local }}", delete: 1 }
        validate_certs: false
      register: m_res

    - name: "TEST | 3-3 | Return Template"
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ test_vm.target_node }}/qemu/{{ test_vm.template_id }}/migrate"
        method: POST
        headers: { Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}" }
        body_format: form-urlencoded
        body: { target: "server-01" }
        validate_certs: false

    - name: "TEST | 3-4 | Wait for Move Disk"
      ansible.builtin.uri:
        url: "https://{{ pve_api_host }}:8006/api2/json/nodes/{{ test_vm.target_node }}/tasks/{{ m_res.json.data }}/status"
        method: GET
        headers: { Authorization: "PVEAPIToken={{ pve_user }}!{{ pve_token_name }}={{ pve_token_secret }}" }
        validate_certs: false
      register: poll
      until: "poll.json.data.status == 'stopped'"
      retries: 100
      delay: 5