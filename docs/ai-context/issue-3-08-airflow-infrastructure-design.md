# Issue #3-08: Airflow Infrastructure Design & Orchestration Setup

## ğŸ“… ë‚ ì§œ: 2026-01-02
## ğŸ‘¤ ì°¸ì—¬ì: [ì„ì„±í˜„], Gemini

## 1. ì´ìŠˆ ê°œìš”
- **ëª©í‘œ**: ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì›Œí¬í”Œë¡œìš° ê´€ë¦¬ ë° ìŠ¤ì¼€ì¤„ë§ì„ ìœ„í•œ Apache Airflow ì¸í”„ë¼ ì„¤ê³„ ë° êµ¬ì¶• ì „ëµ ìˆ˜ë¦½.
- **ê²°ê³¼**: `k8s-worker-01` ë…¸ë“œ ê¸°ë°˜ì˜ Orchestration í™˜ê²½ ì„¤ê³„ ì™„ë£Œ, Persistence í™•ë³´ ë°©ì•ˆ, MinIO ë¡œê·¸ ì—°ë™, Git-Sync ë„ì… ë° RBAC êµ¬ì¡° í™•ì •.

## 2. ì£¼ìš” ì„±ê³¼ ë° ëŒ€í™” ìš”ì•½
- **Orchestration ë…¸ë“œ íŠ¹í™”**: `k8s-worker-01`ì„ ì „ìš© ë…¸ë“œë¡œ ì§€ì •í•˜ì—¬ ìì› ê°„ì„­ ìµœì†Œí™” ë° íš¨ìœ¨ì  ìŠ¤ì¼€ì¤„ë§ í™˜ê²½ êµ¬ì„±.
- **Persistence ì „ëµ ìˆ˜ë¦½**: í´ëŸ¬ìŠ¤í„° ë‚´ StorageClass ë¶€ì¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Proxmox ê°€ìƒ ë””ìŠ¤í¬ ê¸°ë°˜ì˜ Static Provisioning(Manual PV) ë°©ì‹ ì±„íƒ.
- **ì¤‘ì•™ ì§‘ì¤‘í˜• ë¡œê·¸ ì‹œìŠ¤í…œ**: Sparkì™€ ë™ì¼í•˜ê²Œ MinIO(`datalake`)ë¥¼ í™œìš©í•˜ì—¬ Airflow ë¡œê·¸ë¥¼ í†µí•© ê´€ë¦¬í•¨ìœ¼ë¡œì¨ ê°€ìš©ì„± í™•ë³´.
- **GitOps ê¸°ë°˜ DAG ê´€ë¦¬**: `git-sync` ì‚¬ì´ë“œì¹´ë¥¼ í†µí•´ ë°°í¬ ì—†ì´ ì½”ë“œ ë³€ê²½ë§Œìœ¼ë¡œ DAGë¥¼ ìë™ ë°˜ì˜í•˜ëŠ” êµ¬ì¡° ì„¤ê³„.

## 3. ê¸°ìˆ ì  ì˜ì‚¬ê²°ì • ë° íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 3.1 StorageClass ë° ë°ì´í„° ë³´ì¡´ (Persistence)
- **ê²°ì •**: `k8s-worker-01`ì— 50GB ê°€ìƒ ë””ìŠ¤í¬ ì¶”ê°€ ë° `/mnt/airflow-data` ë§ˆìš´íŠ¸ í›„ **Manual PV** ìƒì„±.
- **ì´ìœ **: Dynamic Provisioning ì„¤ì •ì´ ì–´ë ¤ìš´ í™˜ê²½ì—ì„œ ë©”íƒ€ë°ì´í„°(PostgreSQL)ì˜ ì˜ì†ì„±ì„ ë³´ì¥í•˜ê¸° ìœ„í•œ ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•.

### 3.2 MinIO ì—°ë™ ë° ë³´ì•ˆ ì •ì±…
- **ê³„ì •**: `airflow-admin` (ë³„ë„ Access/Secret Key ìƒì„±)
- **ê¶Œí•œ(Policy)**: `datalake` ë²„í‚·ì— ëŒ€í•œ ë¦¬ìŠ¤íŠ¸ ê¶Œí•œ ë° `logs/airflow-logs/*` ê²½ë¡œì— ëŒ€í•œ ì½ê¸°/ì“°ê¸° ê¶Œí•œìœ¼ë¡œ ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì¤€ìˆ˜.

### 3.3 RBAC êµ¬ì¡° ë¶„ë¦¬: spark-sa vs airflow-sa
- **êµ¬ë¶„**:
    - `spark-sa`: Spark Job ì‹¤í–‰ ë° ë°ì´í„° ì²˜ë¦¬ìš© (ì‘ì—…ì).
    - `airflow-sa`: K8s APIë¥¼ í†µí•œ íŒŒë“œ ì œì–´ ë° `SparkApplication` ë¦¬ì†ŒìŠ¤ ê´€ë¦¬ìš© (ì§€íœ˜ì).
- **ê²°ì •**: ë³„ë„ì˜ SAë¥¼ ìƒì„±í•˜ê³  `SparkApplication` ì»¤ìŠ¤í…€ ë¦¬ì†ŒìŠ¤ë¥¼ ì œì–´í•  ìˆ˜ ìˆëŠ” `ClusterRole` ë¶€ì—¬.

### 3.4 Airflow ì´ë¯¸ì§€ ë° íŒ¨í‚¤ì§€ ì„ ì •
- **ë²„ì „**: Apache Airflow 2.10.4 (Python 3.12 ê¸°ë°˜)
- **í•„ìˆ˜ Provider**: `apache-airflow-providers-amazon`, `apache-airflow-providers-cncf-kubernetes`, `apache-airflow-providers-postgres`.

## 4. ê²°ë¡  ë° í–¥í›„ ê³„íš
- **ê²°ë¡ **: ë¦¬ì†ŒìŠ¤ ì œì•½ì´ ìˆëŠ” í•˜ì´ë¸Œë¦¬ë“œ ì¸í”„ë¼(Proxmox/K8s)ì—ì„œ ê³ ê°€ìš©ì„±ê³¼ í™•ì¥ì„±ì„ ëª¨ë‘ ê³ ë ¤í•œ Airflow ì•„í‚¤í…ì²˜ ì„¤ê³„ë¥¼ ì™„ë£Œí•¨.
- **ì°¨ê¸° ê³¼ì œ**: 
    1. **[ì§„í–‰ ì¤‘]** `k8s-worker-01` ë…¸ë“œ í•˜ë“œë””ìŠ¤í¬ ì¶”ê°€ ë° ë§ˆìš´íŠ¸.
    2. Airflowìš© PV/PVC ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„± ë° ë°°í¬.
    3. Helm Chartë¥¼ í™œìš©í•œ `KubernetesExecutor` ëª¨ë“œ ë°°í¬ ë° Git-Sync í…ŒìŠ¤íŠ¸.

---

## ğŸ› ï¸ ì‹¤ë¬´ ê°€ì´ë“œ: k8s-worker-01 ë””ìŠ¤í¬ ì¶”ê°€ ë° ë§ˆìš´íŠ¸

Airflowì˜ ë©”íƒ€ë°ì´í„° DBì™€ ë¡œê·¸ ì„ì‹œ ì €ì¥ ë“±ì„ ìœ„í•´ **50GB**ì˜ ìš©ëŸ‰ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤. í™ˆ ì„œë²„ í™˜ê²½ì—ì„œ ê´€ë¦¬ê°€ ìš©ì´í•˜ë„ë¡ `/mnt/airflow-data` ê²½ë¡œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 1. Proxmoxì—ì„œ ê°€ìƒ ë””ìŠ¤í¬ ì¶”ê°€
1. Proxmox ì›¹ UI ì ‘ì† í›„ VM 301 (`k8s-worker-01`) ì„ íƒ.
2. **Hardware** íƒ­ -> **Add** -> **Hard Disk** í´ë¦­.
3. StorageëŠ” `local-lvm` ì„ íƒ, Disk SizeëŠ” `50` (GB) ì…ë ¥ í›„ Add.
   - *ì°¸ê³ : ë²„ìŠ¤ íƒ€ì…ì€ ê¸°ì¡´ê³¼ ë™ì¼í•œ SCSI ë˜ëŠ” VirtIO Blockì„ ê¶Œì¥í•©ë‹ˆë‹¤.*

### 2. VM ë‚´ë¶€(Ubuntu) ë””ìŠ¤í¬ ì„¤ì • ë° ë§ˆìš´íŠ¸
vm-bastionì„ í†µí•´ `k8s-worker-01`(.31)ì— ì ‘ì†í•˜ì—¬ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

#### â‘  ë””ìŠ¤í¬ ì¸ì‹ í™•ì¸
```bash
# ìƒˆë¡œ ì¶”ê°€ëœ ë””ìŠ¤í¬(ë³´í†µ /dev/sdb ë˜ëŠ” /dev/vdb) í™•ì¸
lsblk
```
- ê²°ê³¼ì— `SIZE`ê°€ 50Gì¸ ì¥ì¹˜ëª…ì„ í™•ì¸í•˜ì„¸ìš”. (ì´í•˜ `/dev/sdb`ë¡œ ê°€ì •)

#### â‘¡ íŒŒì¼ ì‹œìŠ¤í…œ ìƒì„± (í¬ë§·)
```bash
# ext4 í˜•ì‹ìœ¼ë¡œ í¬ë§·
sudo mkfs.ext4 /dev/sdb
```

#### â‘¢ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ìƒì„± ë° ë§ˆìš´íŠ¸
```bash
# ë§ˆìš´íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
sudo mkdir -p /mnt/airflow-data

# ë§ˆìš´íŠ¸ ì‹¤í–‰
sudo mount /dev/sdb /mnt/airflow-data

# ê¶Œí•œ ì„¤ì • (Airflow íŒŒë“œê°€ ì“¸ ìˆ˜ ìˆë„ë¡ 777 ë¶€ì—¬ ë˜ëŠ” ì†Œìœ ê¶Œ ì¡°ì •)
sudo chmod -R 777 /mnt/airflow-data
```

#### â‘£ ë¶€íŒ… ì‹œ ìë™ ë§ˆìš´íŠ¸ ì„¤ì • (ì˜êµ¬ ë°˜ì˜)
ì¬ë¶€íŒ… í›„ì—ë„ ë§ˆìš´íŠ¸ê°€ ìœ ì§€ë˜ë„ë¡ `/etc/fstab`ì— ë“±ë¡í•©ë‹ˆë‹¤.
```bash
# UUID í™•ì¸
sudo blkid /dev/sdb

# /etc/fstab í¸ì§‘ (ìœ„ì—ì„œ í™•ì¸í•œ UUID ì…ë ¥)
# ì˜ˆ: UUID=xxxx-xxxx /mnt/airflow-data ext4 defaults 0 0
sudo vi /etc/fstab
```

### 3. ê²°ê³¼ í™•ì¸
```bash
# ìš©ëŸ‰ ë° ë§ˆìš´íŠ¸ ìƒíƒœ ìµœì¢… í™•ì¸
df -h | grep airflow-data
```
